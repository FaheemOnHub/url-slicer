<h1>Analytics Dashboard</h1>

<div class="analytics-container">
  <div class="panel">
    <h2>Overall Statistics</h2>
    <div class="stats-grid">
      <div class="stat-box">
        <h3>Total Clicks</h3>
        <p id="total-clicks">Loading...</p>
      </div>
      <div class="stat-box">
        <h3>Total URLs</h3>
        <p id="total-urls">Loading...</p>
      </div>
      <div class="stat-box">
        <h3>Average CTR</h3>
        <p id="average-ctr">Loading...</p>
      </div>
    </div>
  </div>

  <div class="panel">
    <h2>Clickthrough Rates Over Time</h2>
    <canvas id="ctrChart"></canvas>
  </div>

  <div class="panel">
    <h2>Geo Distribution of Clicks</h2>
    <div id="country-list" class="country-list"></div>
  </div>

  <div class="panel" class="statsChart">
    <h2>Device Statistics</h2>
    <canvas id="deviceChart"></canvas>
  </div>

  <div class="panel" class="statsChart">
    <h2>Browser Statistics</h2>
    <canvas id="browserChart"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  fetch('/api/analytics')
    .then(response => response.json())
    .then(data => {
      updateOverallStats(data);
      createCTRChart(data.ctrOverTime);
      createCountryList(data.geoDistribution);
      createDeviceChart(data.deviceStats);
      createBrowserChart(data.browserStats);
    })
    .catch(error => console.error('Error fetching analytics data:', error));
});

function updateOverallStats(data) {
  document.getElementById('total-clicks').textContent = data.totalClicks;
  document.getElementById('total-urls').textContent = data.totalUrls;
  document.getElementById('average-ctr').textContent = (data.averageCTR * 100).toFixed(2) + '%';
}

function createCTRChart(ctrData) {
  const ctx = document.getElementById('ctrChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: ctrData.map(d => d._id),
      datasets: [{
        label: 'CTR',
        data: ctrData.map(d => d.ctr * 100),
        borderColor: 'rgb(75, 192, 192)',
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return value + '%';
            }
          }
        }
      }
    }
  });
}

function createCountryList(geoData) {
  const countryList = document.getElementById('country-list');
  const sortedCountries = Object.entries(geoData)
    .sort((a, b) => b[1] - a[1]);  // Sort by click count, descending

  let listHtml = '<ul class="country-stats">';
  sortedCountries.forEach(([country, clicks]) => {
    listHtml += `
      <li class="country-stat-item">
        <span class="country-name">${country}</span>
        <span class="country-clicks">${clicks} click${clicks !== 1 ? 's' : ''}</span>
      </li>
    `;
  });
  listHtml += '</ul>';

  countryList.innerHTML = listHtml;
}

function createDeviceChart(deviceData) {
  const ctx = document.getElementById('deviceChart').getContext('2d');
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: deviceData.map(d => d._id),
      datasets: [{
        data: deviceData.map(d => d.count),
        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56']
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'top',
        },
        title: {
          display: true,
          text: 'Device Usage'
        }
      }
    }
  });
}

function createBrowserChart(browserData) {
  const ctx = document.getElementById('browserChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: browserData.map(d => d._id),
      datasets: [{
        label: 'Usage',
        data: browserData.map(d => d.count),
        backgroundColor: 'rgba(75, 192, 192, 0.6)',
        borderColor: 'rgba(75, 192, 192, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
}
</script>

<style>
.country-list {
  max-height: 400px;
  overflow-y: auto;
}

.country-stats {
  list-style-type: none;
  padding: 0;
}

.country-stat-item {
  display: flex;
  justify-content: space-between;
  padding: 10px;
  border-bottom: 1px solid #eee;
}

.country-stat-item:last-child {
  border-bottom: none;
}

.country-name {
  font-weight: bold;
}

.country-clicks {
  color: #666;
}
</style>