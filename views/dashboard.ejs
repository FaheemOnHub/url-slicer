<h1>Dashboard</h1>
<p>Welcome, <%= user.email %>!</p>

<div class="dashboard-tabs">
  <button id="shortener-tab" class="tab-button active">URL Shortener</button>
  <button id="urls-tab" class="tab-button">Shortened URLs</button>
</div>

<div id="shortener-content" class="tab-content">
  <div class="panel">
    <h2>Shorten a URL</h2>
    <form id="shorten-form">
      <div class="form-group">
        <label for="original-url">Original URL:</label>
        <input type="url" id="original-url" name="originalUrl" required>
      </div>
      <div class="form-group">
        <label for="max-uses">Max Uses:</label>
        <input type="number" id="max-uses" name="maxUses" min="1">
      </div>
      <div class="form-group">
        <label for="auto-delete-at">Auto Delete At:</label>
        <input type="datetime-local" id="auto-delete-at" name="autoDeleteAt">
      </div>
      <div class="form-group">
        <label for="whitelist-mode">
          <input type="checkbox" id="whitelist-mode" name="whitelistMode">
          Whitelist Mode
        </label>
      </div>
      <div class="form-group">
        <label for="allowed-countries">Allowed Countries (comma-separated):</label>
        <input type="text" id="allowed-countries" name="allowedCountries">
      </div>
      <div class="form-group">
        <label for="blocked-countries">Blocked Countries (comma-separated):</label>
        <input type="text" id="blocked-countries" name="blockedCountries">
      </div>
      <button type="submit" class="btn btn-primary">Shorten URL</button>
    </form>
  </div>
</div>

<div id="urls-content" class="tab-content" style="display: none;">
  <div class="panel">
    <h2>Your Shortened URLs</h2>
    <ul class="url-list">
      <% urls.forEach(function(url) { %>
        <li class="url-item">
          <h3><%= url.original_url %></h3>
          <p>Short URL: <a href="/<%= url.short_code %>" target="_blank"><%= url.short_code %></a></p>
          <p>Created: <%= new Date(url.created_at).toLocaleString() %></p>
          <p>Max Uses: <%= url.max_uses || 'Unlimited' %></p>
          <p>Auto Delete At: <%= url.auto_delete_at ? new Date(url.auto_delete_at).toLocaleString() : 'Never' %></p>
          <p>Whitelist Mode: <%= url.whitelist_mode ? 'On' : 'Off' %></p>
          <p>Allowed Countries: <%= url.allowed_countries || 'All' %></p>
          <p>Blocked Countries: <%= url.blocked_countries || 'None' %></p>
          <div class="url-actions">
            <button class="btn btn-secondary view-stats" data-short-code="<%= url.short_code %>">View Stats</button>
            <button class="btn btn-secondary edit-url" data-short-code="<%= url.short_code %>">Edit</button>
            <button class="btn btn-secondary delete-url" data-short-code="<%= url.short_code %>">Delete</button>
          </div>
        </li>
      <% }); %>
    </ul>
  </div>
</div>

<div id="stats-modal" class="modal">
  <div class="modal-content panel">
    <span class="close-modal">&times;</span>
    <h2>URL Statistics</h2>
    <div id="stats-content"></div>
  </div>
</div>

<div id="edit-modal" class="modal">
  <div class="modal-content panel">
    <span class="close-modal">&times;</span>
    <h2>Edit URL</h2>
    <form id="edit-form">
      <input type="hidden" id="edit-short-code" name="shortCode">
      <div class="form-group">
        <label for="edit-max-uses">Max Uses:</label>
        <input type="number" id="edit-max-uses" name="maxUses" min="1">
      </div>
      <div class="form-group">
        <label for="edit-auto-delete-at">Auto Delete At:</label>
        <input type="datetime-local" id="edit-auto-delete-at" name="autoDeleteAt">
      </div>
      <div class="form-group">
        <label for="edit-whitelist-mode">
          <input type="checkbox" id="edit-whitelist-mode" name="whitelistMode">
          Whitelist Mode
        </label>
      </div>
      <div class="form-group">
        <label for="edit-allowed-countries">Allowed Countries (comma-separated):</label>
        <input type="text" id="edit-allowed-countries" name="allowedCountries">
      </div>
      <div class="form-group">
        <label for="edit-blocked-countries">Blocked Countries (comma-separated):</label>
        <input type="text" id="edit-blocked-countries" name="blockedCountries">
      </div>
      <button type="submit" class="btn btn-primary">Update URL</button>
    </form>
  </div>
</div>

<script>
$(document).ready(function() {
  // Tab functionality
  $('#shortener-tab').click(function() {
    $('#shortener-content').show();
    $('#urls-content').hide();
    $('.tab-button').removeClass('active');
    $(this).addClass('active');
  });

  $('#urls-tab').click(function() {
    $('#urls-content').show();
    $('#shortener-content').hide();
    $('.tab-button').removeClass('active');
    $(this).addClass('active');
  });

  $('#shortener-tab').click();

  // Form submission
  $('#shorten-form').submit(function(e) {
    e.preventDefault();
    $.ajax({
      url: '/shorten',
      method: 'POST',
      data: $(this).serialize(),
      success: function(response) {
        alert('URL shortened successfully! Short code: ' + response.shortCode);
        location.reload();
      },
      error: function(xhr, status, error) {
        alert('Error: ' + xhr.responseJSON.error);
      }
    });
  });

  // View stats
  $('.view-stats').click(function() {
    var shortCode = $(this).data('short-code');
    $.ajax({
      url: '/stats/' + shortCode,
      method: 'GET',
      success: function(response) {
        var statsHtml = '<p>Original URL: ' + response.url.original_url + '</p>';
        statsHtml += '<p>Total Clicks: ' + response.clicks.length + '</p>';
        
        var countryStats = {};
        response.clicks.forEach(function(click) {
          if (countryStats[click.country]) {
            countryStats[click.country]++;
          } else {
            countryStats[click.country] = 1;
          }
        });

        statsHtml += '<h3>Clicks by Country:</h3>';
        statsHtml += '<ul>';
        for (var country in countryStats) {
          statsHtml += '<li>' + country + ': ' + countryStats[country] + '</li>';
        }
        statsHtml += '</ul>';

        $('#stats-content').html(statsHtml);
        $('#stats-modal').show();
      },
      error: function(xhr, status, error) {
        alert('Error: ' + xhr.responseJSON.error);
      }
    });
  });

  // Edit URL
  $('.edit-url').click(function() {
    var shortCode = $(this).data('short-code');
    $.ajax({
      url: '/url/' + shortCode,
      method: 'GET',
      success: function(response) {
        $('#edit-short-code').val(shortCode);
        $('#edit-max-uses').val(response.max_uses);
        $('#edit-auto-delete-at').val(response.auto_delete_at);
        $('#edit-whitelist-mode').prop('checked', response.whitelist_mode);
        $('#edit-allowed-countries').val(response.allowed_countries);
        $('#edit-blocked-countries').val(response.blocked_countries);
        $('#edit-modal').show();
      },
      error: function(xhr, status, error) {
        alert('Error: ' + xhr.responseJSON.error);
      }
    });
  });

  $('#edit-form').submit(function(e) {
    e.preventDefault();
    var shortCode = $('#edit-short-code').val();
    $.ajax({
      url: '/url/' + shortCode,
      method: 'PUT',
      data: $(this).serialize(),
      success: function(response) {
        alert('URL updated successfully!');
        location.reload();
      },
      error: function(xhr, status, error) {
        alert('Error: ' + xhr.responseJSON.error);
      }
    });
  });

  // Delete URL
  $('.delete-url').click(function() {
    var shortCode = $(this).data('short-code');
    if (confirm('Are you sure you want to delete this URL?')) {
      $.ajax({
        url: '/url/' + shortCode,
        method: 'DELETE',
        success: function(response) {
          alert('URL deleted successfully!');
          location.reload();
        },
        error: function(xhr, status, error) {
          alert('Error: ' + xhr.responseJSON.error);
        }
      });
    }
  });

  // Close modals
  $('.close-modal').click(function() {
    $('.modal').hide();
  });

  $(window).click(function(event) {
    if ($(event.target).hasClass('modal')) {
      $('.modal').hide();
    }
  });
});
</script>